{% extends 'base_chat.html' %}

{% block title %}Chat - MamiCoach{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50">
    <!-- Chat Sessions Sidebar -->
    <div class="w-full md:w-1/3 bg-white border-r border-gray-200 flex flex-col">
        <!-- Header -->
        <div class="p-4 bg-primary text-white flex-shrink-0">
            <h1 class="text-xl font-bold">Chats</h1>
        </div>
        
        <!-- Search Bar -->
        <div class="p-4 border-b flex-shrink-0">
            <input type="text" 
                   id="search-sessions" 
                   placeholder="Search conversations..." 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
        </div>
        
        <!-- Chat Sessions List -->
        <div id="sessions-container" class="flex-1 overflow-y-auto">
            <div id="sessions-list">
                <!-- Sessions will be loaded here via AJAX -->
            </div>
            <div id="sessions-loading" class="p-4 text-center text-gray-500">
                Loading conversations...
            </div>
        </div>
    </div>

    <!-- Chat Area (Desktop Only) -->
    <div class="hidden md:flex flex-1 flex-col">
        <!-- Welcome Message -->
        <div id="welcome-message" class="flex-1 flex items-center justify-center bg-gray-50">
            <div class="text-center text-gray-500">
                <div class="w-24 h-24 mx-auto mb-4 bg-gray-200 rounded-full flex items-center justify-center">
                    <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.013 8.013 0 01-7-4.997 11.995 11.995 0 002.31-6.31 8 8 0 018 8z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">Welcome to Chat</h3>
                <p class="text-gray-500">Select a conversation to start messaging</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;

// Load chat sessions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadChatSessions();
    
    // Handle search functionality
    const searchInput = document.getElementById('search-sessions');
    searchInput.addEventListener('input', function() {
        // Add debounced search functionality here
        // For now, just filter existing sessions
        filterSessions(this.value);
    });
});

async function loadChatSessions() {
    try {
        const response = await fetch('/api/chat/sessions/');
        const data = await response.json();
        
        const container = document.getElementById('sessions-list');
        const loading = document.getElementById('sessions-loading');
        
        if (loading) loading.style.display = 'none';
        
        if (data.sessions && data.sessions.length > 0) {
            container.innerHTML = data.sessions.map(createSessionItem).join('');
        } else {
            container.innerHTML = '<div class="p-4 text-center text-gray-500">No conversations yet</div>';
        }
    } catch (error) {
        console.error('Error loading sessions:', error);
        document.getElementById('sessions-loading').textContent = 'Error loading conversations';
    }
}

function createSessionItem(session) {
    const lastMessageTime = session.last_message.timestamp ? 
        new Date(session.last_message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 
        '';
    
    const unreadBadge = session.unread_count > 0 ? 
        `<span class="bg-primary text-white text-xs rounded-full px-2 py-1 ml-2 min-w-0">${session.unread_count}</span>` : 
        '';
    
    const lastMessagePreview = session.last_message.content ? 
        `${session.last_message.sender_is_me ? '<span class="text-gray-400">You: </span>' : ''}${session.last_message.content.substring(0, 30)}${session.last_message.content.length > 30 ? '...' : ''}` :
        '<span class="text-gray-400 italic">No messages yet</span>';
    
    return `
        <div class="session-item p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors" 
             data-session-id="${session.id}" 
             onclick="selectSession('${session.id}')">
            <div class="flex items-center">
                <!-- Profile Picture / Avatar -->
                <div class="w-12 h-12 bg-primary text-white rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                    <span class="font-semibold">
                        ${session.other_user.first_name ? session.other_user.first_name.charAt(0).toUpperCase() : session.other_user.username.charAt(0).toUpperCase()}
                    </span>
                </div>
                
                <!-- Chat Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start">
                        <h3 class="session-name font-semibold text-gray-900 truncate">
                            ${session.other_user.first_name || session.other_user.username} ${session.other_user.last_name || ''}
                        </h3>
                        <span class="text-xs text-gray-500 ml-2">
                            ${lastMessageTime}
                        </span>
                    </div>
                    
                    <div class="flex justify-between items-center mt-1">
                        <p class="last-message text-sm text-gray-600 truncate flex-1">
                            ${lastMessagePreview}
                        </p>
                        ${unreadBadge}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function selectSession(sessionId) {
    // On mobile, navigate to the detail page
    if (window.innerWidth <= 768) {
        window.location.href = `/chat/${sessionId}/`;
        return;
    }
    
    // On desktop, load chat in the sidebar (existing behavior)
    currentSessionId = sessionId;
    
    // Update active session styling
    document.querySelectorAll('.session-item').forEach(item => {
        item.classList.remove('bg-primary/10');
    });
    document.querySelector(`[data-session-id="${sessionId}"]`).classList.add('bg-primary/10');
    
    // Load chat messages (desktop implementation would go here)
    // For now, just show a placeholder
    const welcomeMessage = document.getElementById('welcome-message');
    if (welcomeMessage) {
        welcomeMessage.innerHTML = `
            <div class="text-center text-gray-500">
                <p>Chat detail view would load here on desktop</p>
                <p>Session ID: ${sessionId}</p>
                <p>For mobile users, please navigate to individual chat pages</p>
            </div>
        `;
    }
}

function filterSessions(searchTerm) {
    const sessions = document.querySelectorAll('.session-item');
    const term = searchTerm.toLowerCase();
    
    sessions.forEach(session => {
        const name = session.querySelector('.session-name').textContent.toLowerCase();
        const lastMessage = session.querySelector('.last-message').textContent.toLowerCase();
        
        if (name.includes(term) || lastMessage.includes(term)) {
            session.style.display = 'block';
        } else {
            session.style.display = 'none';
        }
    });
}
</script>
{% endblock %}