{% extends 'base_chat.html' %}

{% block title %}Chat with {{ other_user.first_name|default:other_user.username }} - MamiCoach{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 overflow-hidden">
    <!-- Chat Container -->
    <div class="flex-1 flex flex-col min-h-0">
        <!-- Chat Header - Fixed -->
        <div class="bg-white border-b border-gray-200 p-4 flex items-center flex-shrink-0 z-10">
            <div class="flex items-center flex-1 min-w-0">
                <!-- Back Button -->
                <a href="/chat/" class="mr-3 text-gray-600 hover:text-gray-800 flex-shrink-0">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                
                <!-- Profile Picture -->
                <div class="w-10 h-10 bg-primary text-white rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                    <span class="font-semibold">
                        {{ other_user.first_name.0|default:other_user.username.0|upper }}
                    </span>
                </div>
                
                <!-- User Info -->
                <div class="min-w-0 flex-1">
                    <h2 class="font-semibold text-gray-900 truncate">
                        {% if other_user.first_name %}{{ other_user.first_name }} {{ other_user.last_name|default:"" }}{% else %}{{ other_user.username }}{% endif %}
                    </h2>
                    <p class="text-sm text-gray-500">
                        {% if other_user.is_online %}
                            <span class="text-green-500 flex items-center">
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span>
                                Online
                            </span>
                        {% else %}
                            Last seen recently
                        {% endif %}
                    </p>
                </div>
            </div>
            
            <!-- Chat Actions -->
            <div class="flex space-x-2 flex-shrink-0">
                <button class="p-2 text-gray-500 hover:text-gray-700 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Messages Container - Scrollable -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 bg-gray-50 min-h-0" style="background-image: url('data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 100 100\'%3E%3Cdefs%3E%3Cpattern id=\'chat-bg\' x=\'0\' y=\'0\' width=\'100\' height=\'100\' patternUnits=\'userSpaceOnUse\'%3E%3Ccircle cx=\'50\' cy=\'50\' r=\'1\' fill=\'%23f3f4f6\' opacity=\'0.1\'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width=\'100\' height=\'100\' fill=\'url(%23chat-bg)\'/%3E%3C/svg%3E');">
            <div id="messages-list">
                <!-- Messages will be loaded here -->
            </div>
            <div id="messages-loading" class="text-center text-gray-500 py-4">
                Loading messages...
            </div>
        </div>

        <!-- Message Input - Fixed -->
        <div class="bg-white border-t border-gray-200 p-4 flex-shrink-0">
            <form id="message-form" class="flex space-x-3">
                <input type="hidden" id="session-id" value="{{ session.id }}">
                <div class="flex-1 relative">
                    <input type="text" 
                           id="message-input" 
                           placeholder="Type a message..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                           maxlength="1000">
                    <button type="button" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </button>
                </div>
                <button type="submit" 
                        id="send-button"
                        class="bg-primary text-white p-3 rounded-full hover:bg-primary/90 transition-colors disabled:opacity-50 flex-shrink-0">
                    <!-- Send icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 3 3 9-3 9 19-9Z"/>
                        <path d="m6 12 13 0"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
const currentSessionId = '{{ session.id }}';

document.addEventListener('DOMContentLoaded', function() {
    loadMessages(currentSessionId);
    
    // Message input handling
    const messageInput = document.getElementById('message-input');
    const messageForm = document.getElementById('message-form');
    const sendButton = document.getElementById('send-button');
    
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            sendButton.disabled = this.value.trim() === '';
        });
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.value.trim()) {
                    sendMessage(currentSessionId);
                }
            }
        });
        
        // Initial state
        sendButton.disabled = messageInput.value.trim() === '';
        messageInput.focus();
    }
    
    if (messageForm) {
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (messageInput.value.trim()) {
                sendMessage(currentSessionId);
            }
        });
    }
});

async function loadMessages(sessionId) {
    try {
        const response = await fetch(`/api/chat/${sessionId}/messages/`);
        const data = await response.json();
        
        const container = document.getElementById('messages-list');
        const loading = document.getElementById('messages-loading');
        
        if (loading) loading.style.display = 'none';
        
        if (data.messages && data.messages.length > 0) {
            container.innerHTML = data.messages.map(createMessageItem).join('');
        } else {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</div>';
        }
        
        scrollToBottom();
        await markMessagesAsRead(sessionId);
    } catch (error) {
        console.error('Error loading messages:', error);
        const loading = document.getElementById('messages-loading');
        if (loading) loading.textContent = 'Error loading messages';
    }
}

function createMessageItem(message) {
    const isOwn = message.is_sent_by_me;
    const messageTime = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    return `
        <div class="mb-4 flex ${isOwn ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs lg:max-w-md">
                <div class="${isOwn ? 'bg-primary text-white' : 'bg-white text-gray-900'} rounded-2xl px-4 py-2 shadow-sm">
                    <p class="break-words">${escapeHtml(message.content)}</p>
                </div>
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mt-1">
                    <span class="text-xs text-gray-500 flex items-center">
                        ${messageTime}
                        ${isOwn ? (message.read ? 
                            '<svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 7 17l-5-5"/><path d="m22 10-7.5 7.5L13 16"/></svg>' : 
                            '<svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>') : ''}
                    </span>
                </div>
            </div>
        </div>
    `;
}

async function sendMessage(sessionId) {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    try {
        const response = await fetch('/api/chat/send/', {
            method: 'POST',
            body: JSON.stringify({
                session_id: sessionId,
                content: content
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            messageInput.value = '';
            const messagesContainer = document.getElementById('messages-list');
            const messageHtml = createMessageItem({
                ...data.message,
                is_sent_by_me: true
            });
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            scrollToBottom();
        } else {
            alert('Error sending message: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message. Please try again.');
    } finally {
        messageInput.disabled = false;
        sendButton.disabled = messageInput.value.trim() === '';
        messageInput.focus();
    }
}

async function markMessagesAsRead(sessionId) {
    try {
        await fetch('/api/chat/mark-read/', {
            method: 'POST',
            body: JSON.stringify({
                session_id: sessionId
            })
        });
    } catch (error) {
        console.error('Error marking messages as read:', error);
    }
}

function scrollToBottom() {
    const container = document.getElementById('messages-container');
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}

<!-- Message Input -->
<div class="bg-white border-t border-gray-200 p-4">
    <form id="message-form" class="flex space-x-3">
        <input type="hidden" id="session-id" value="{{ session.id }}">
        <div class="flex-1 relative">
            <input type="text" 
                   id="message-input" 
                   placeholder="Type a message..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                   maxlength="1000">
            <button type="button" 
                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1.01M15 10h1.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
        </div>
        <button type="submit" 
                id="send-button"
                class="bg-primary text-white p-3 rounded-full hover:bg-primary/90 transition-colors disabled:opacity-50">
            <svg class="w-5 h-5 transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
        </button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionId = document.getElementById('session-id').value;
    
    loadMessages(sessionId);
    
    // Message form submission
    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage(sessionId);
    });
    
    // Enter key to send message
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage(sessionId);
        }
    });
    
    // Auto-resize input and enable/disable send button
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    
    messageInput.addEventListener('input', function() {
        sendButton.disabled = this.value.trim() === '';
    });
    
    // Initial state
    sendButton.disabled = messageInput.value.trim() === '';
});

async function loadMessages(sessionId) {
    try {
        const response = await fetch(`/api/chat/${sessionId}/messages/`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        const container = document.getElementById('messages-list');
        const loading = document.getElementById('messages-loading');
        
        loading.style.display = 'none';
        
        if (data.messages && data.messages.length > 0) {
            container.innerHTML = data.messages.map(message => 
                createMessageItem(message, data.current_user_id)
            ).join('');
        } else {
            container.innerHTML = '<div class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</div>';
        }
        
        // Scroll to bottom
        const messagesContainer = document.getElementById('messages-container');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Mark messages as read
        await markMessagesAsRead(sessionId);
    } catch (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messages-loading').textContent = 'Error loading messages';
    }
}

function createMessageItem(message, currentUserId) {
    const isOwn = message.is_sent_by_me;
    const messageTime = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    return `
        <div class="mb-4 flex ${isOwn ? 'justify-end' : 'justify-start'}">
            <div class="max-w-xs lg:max-w-md ${isOwn ? 'order-1' : 'order-2'}">
                <div class="${isOwn ? 'bg-primary text-white' : 'bg-white text-gray-900'} rounded-2xl px-4 py-2 shadow-sm">
                    <p class="break-words">${escapeHtml(message.content)}</p>
                </div>
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mt-1">
                    <span class="text-xs text-gray-500">
                        ${messageTime}
                        ${isOwn ? (message.read ? ' &#10003;&#10003;' : ' &#10003;') : ''}
                    </span>
                </div>
            </div>
        </div>
    `;
}

async function sendMessage(sessionId) {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    // Disable input while sending
    messageInput.disabled = true;
    sendButton.disabled = true;
    
    try {
        const response = await fetch('/api/chat/send/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                content: content
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Clear input
            messageInput.value = '';
            
            // Add message to UI immediately
            const messagesContainer = document.getElementById('messages-list');
            const messageHtml = createMessageItem(data.message, true); // true because it's from current user
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            
            // Scroll to bottom
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
            
            // Update session list (optional - refresh last message)
            // loadChatSessions();
        } else {
            alert('Error sending message: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message. Please try again.');
    } finally {
        // Re-enable input
        messageInput.disabled = false;
        sendButton.disabled = messageInput.value.trim() === '';
        messageInput.focus();
    }
}

async function markMessagesAsRead(sessionId) {
    try {
        await fetch('/api/chat/mark-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
    } catch (error) {
        console.error('Error marking messages as read:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>