<!-- Review Form Partial -->
<section class="min-h-screen bg-gradient-to-br from-neutral-50 to-neutral-100 py-6 sm:py-12">
	<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
		<!-- Header -->
		<div class="mb-8 text-center lg:text-left">
			<p class="text-sm font-medium text-neutral-500 sm:text-base">Course Review Booking#{{ booking.id }}</p>
			<h1 class="mt-2 text-2xl font-bold text-neutral-900 sm:text-3xl lg:text-4xl">
				{% if is_edit %}
					Edit your review for <span class="text-primary">{{ review.coach.user.first_name|default:review.coach.user.username }}</span>
				{% else %}
					Review your experience with <span class="text-primary">{{ booking.coach.user.first_name|default:booking.coach.user.username }}</span>
				{% endif %}
			</h1>
			<p class="mt-2 text-lg text-neutral-600 font-semibold">
				{% if is_edit %}
					{{ review.course.title }}
				{% else %}
					{{ booking.course.title }}
				{% endif %}
			</p>
		</div>

		<!-- Main Content Grid -->
		<div class="grid grid-cols-1 gap-6 lg:grid-cols-12 lg:gap-8">
			<!-- Course Info Card -->
			<div class="lg:col-span-5">
				<div class="sticky top-24 rounded-2xl bg-white p-6 shadow-lg ring-1 ring-black/5 sm:p-8">
					<div class="mb-6 space-y-3">
						<div class="flex items-center gap-3 text-sm text-neutral-600 sm:text-base">
							<svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 011-1h6a1 1 0 011 1v4m-6 0h6m-6 0V3m6 4v10a1 1 0 01-1 1H9a1 1 0 01-1-1V7"></path>
							</svg>
							<span><span class="font-semibold text-neutral-800">Booked:</span>
								{% if is_edit %}
									{{ review.booking.start_datetime|date:"H:i \a\t d M Y" }}
								{% else %}
									{{ booking.start_datetime|date:"H:i \a\t d M Y" }}
								{% endif %}
							</span>
						</div>
						<div class="flex items-center gap-3 text-sm text-neutral-600 sm:text-base">
							<svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
							</svg>
							<span><span class="font-semibold text-neutral-800">Duration:</span>
								{% if is_edit %}
									{% with booking=review.booking %}
										{% if booking.start_datetime and booking.end_datetime %}
											{{ booking.end_datetime|timeuntil:booking.start_datetime }}
										{% else %}
											Unknown duration
										{% endif %}
									{% endwith %}
								{% else %}
									{% if booking.start_datetime and booking.end_datetime %}
										{{ booking.end_datetime|timeuntil:booking.start_datetime }}
									{% else %}
										Unknown duration
									{% endif %}
								{% endif %}
							</span>
						</div>
					</div>
					
					<div class="overflow-hidden rounded-xl">
						<img 
							src="{% if is_edit %}{{ review.course.thumbnail_url|default:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQcTY50AnR35-aKaONIPoeLNh_KrvAq9bwD7A&s' }}{% else %}{{ booking.course.thumbnail_url|default:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQcTY50AnR35-aKaONIPoeLNh_KrvAq9bwD7A&s' }}{% endif %}" 
							alt="{% if is_edit %}{{ review.course.title }}{% else %}{{ booking.course.title }}{% endif %}" 
							class="h-48 w-full object-cover transition-transform hover:scale-105 sm:h-64 lg:h-72" 
						/>
					</div>
				</div>
			</div>

			<!-- Review Form -->
			<div class="lg:col-span-7">
				<form method="post" id="review-form" class="rounded-2xl bg-white p-6 shadow-lg ring-1 ring-black/5 sm:p-8">
					{% csrf_token %}
					
					<!-- Form Errors -->
					{% if form.non_field_errors %}
						<div class="mb-6 rounded-lg bg-red-50 p-4 border border-red-200">
							{% for error in form.non_field_errors %}
								<p class="text-sm text-red-600">{{ error }}</p>
							{% endfor %}
						</div>
					{% endif %}
					
					<!-- General Error Alert -->
					<div id="form-error-alert" class="mb-6 rounded-lg bg-red-50 p-4 border border-red-200 hidden">
						<p class="text-sm font-semibold text-red-700 mb-2">Please fix the following errors:</p>
						<ul id="error-list" class="text-sm text-red-600 space-y-1"></ul>
					</div>
					
					<!-- Reviewer Info & Rating -->
					<div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
						<div class="flex items-center gap-4">
							<div class="h-12 w-12 overflow-hidden rounded-full ring-2 ring-primary/20 sm:h-16 sm:w-16">
								<img src="https://i.pravatar.cc/100" alt="Reviewer avatar" class="h-full w-full object-cover" />
							</div>
							<div>
								<p class="text-lg font-semibold text-neutral-900 sm:text-xl">
									{% if is_edit %}
										{{ review.user.first_name|default:review.user.username }}
									{% else %}
										{{ request.user.first_name|default:request.user.username }}
									{% endif %}
								</p>
								<p class="text-sm text-neutral-500 sm:text-base">
									{% if is_edit %}
										{{ review.user.profile.role|default:"User" }}
									{% else %}
										{{ request.user.profile.role|default:"User" }}
									{% endif %}
								</p>
							</div>
						</div>
						
						<!-- Rating Stars -->
						<div class="flex flex-col gap-2">
							<div class="flex items-center gap-2" role="group" aria-label="Rating">
								{{ form.rating }}
								<div class="flex gap-1" id="star-group">
									{% for star in "12345" %}
									<button
										type="button"
										data-role="rating-star"
										data-value="{{ forloop.counter }}"
										class="flex h-8 w-8 items-center justify-center text-neutral-300 transition hover:scale-110 sm:h-10 sm:w-10 rounded-full"
										aria-label="Rate {{ forloop.counter }} star{% if not forloop.last %}s{% endif %}"
									>
										<svg viewBox="0 0 24 24" fill="currentColor" class="h-6 w-6 sm:h-8 sm:w-8">
											<path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
										</svg>
									</button>
									{% endfor %}
								</div>
							</div>
							<!-- Rating Error Message -->
							{% if form.rating.errors %}
								<div class="text-sm text-red-600 mt-1">
									{% for error in form.rating.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
					</div>

					<!-- Comment Section -->
					<div class="mb-6">
						<label for="{{ form.content.id_for_label }}" class="mb-3 block text-base font-semibold text-neutral-700 sm:text-lg">
							{{ form.content.label }}
						</label>
						{{ form.content }}
						{% if form.content.errors %}
							<p class="mt-2 text-sm text-red-600">{{ form.content.errors.0 }}</p>
						{% endif %}
					</div>

					<!-- Anonymous Checkbox -->
					<div class="mb-8">
						<label class="inline-flex cursor-pointer items-center gap-4 text-neutral-600">
							<div class="relative flex h-6 w-6 items-center justify-center">
								{{ form.is_anonymous }}
								<div class="pointer-events-none absolute inset-0 flex h-6 w-6 items-center justify-center rounded-md bg-[#E6E6E6]">
									<svg id="checkbox-checkmark" viewBox="0 0 20 20" fill="none" class="h-6 w-6 text-[#39A35E] {% if form.is_anonymous.value %}opacity-100{% else %}opacity-0{% endif %} transition-opacity duration-150">
										<path d="M16.707 5.293a1 1 0 0 0-1.414 0L8.5 12.086 6.207 9.793a1 1 0 0 0-1.414 1.414l3 3a1 1 0 0 0 1.414 0l7-7a1 1 0 0 0 0-1.414Z" fill="currentColor" />
									</svg>
								</div>
							</div>
							<span class="text-sm sm:text-base font-semibold">Post anonymously</span>
						</label>
						{% if form.is_anonymous.errors %}
							<p class="mt-2 text-sm text-red-600">{{ form.is_anonymous.errors.0 }}</p>
						{% endif %}
					</div>

					<!-- Action Buttons -->
					<div class="flex flex-col gap-3 sm:flex-row">
						{% if is_edit %}
							<!-- Edit Mode: Submit and Delete buttons -->
							<button
								type="submit"
								id="submit-btn"
								class="flex-1 rounded-xl bg-primary px-6 py-4 text-base font-semibold text-white shadow-md transition hover:bg-primary/90 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/40 focus:ring-offset-2 active:scale-[0.98] sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed"
							>
								Update Review
							</button>
							<button
								type="button"
								onclick="openDeleteModal()"
								class="flex-1 rounded-xl bg-red-500 px-6 py-4 text-base font-semibold text-white shadow-md transition hover:bg-red-600 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-2 active:scale-[0.98] sm:text-lg"
							>
								Delete Review
							</button>
						{% else %}
							<!-- Create Mode: Submit button only -->
							<button
								type="submit"
								id="submit-btn"
								class="w-full rounded-xl bg-primary px-6 py-4 text-base font-semibold text-white shadow-md transition hover:bg-primary/90 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary/40 focus:ring-offset-2 active:scale-[0.98] sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed"
							>
								Submit Review
							</button>
						{% endif %}
					</div>
				</form>

				{% if is_edit %}
				<!-- Hidden Delete Form -->
				<form id="delete-form" action="{{ delete_action }}" method="post" class="hidden">
					{% csrf_token %}
				</form>
				{% endif %}
			</div>
		</div>
	</div>
</section>

{% if is_edit %}
<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 backdrop-blur-sm">
	<div class="mx-4 w-full max-w-md rounded-2xl bg-white p-6 shadow-2xl">
		<div class="mb-4 text-center">
			<div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-red-100">
				<svg class="h-8 w-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
				</svg>
			</div>
			<h3 class="text-xl font-semibold text-neutral-900">Delete Review</h3>
			<p class="mt-2 text-sm text-neutral-600">
				Are you sure you want to delete this review? This action cannot be undone and will permanently remove your review from the system.
			</p>
		</div>
		
		<div class="flex gap-3">
			<button
				type="button"
				onclick="closeDeleteModal()"
				class="flex-1 rounded-xl border border-neutral-300 bg-white px-4 py-3 text-sm font-semibold text-neutral-700 shadow-sm transition hover:bg-neutral-50 focus:outline-none focus:ring-2 focus:ring-neutral-500 focus:ring-offset-2"
			>
				Cancel
			</button>
			<button
				type="button"
				onclick="confirmDelete()"
				class="flex-1 rounded-xl bg-red-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
			>
				Delete Review
			</button>
		</div>
	</div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function () {
	const stars = document.querySelectorAll('[data-role="rating-star"]');
	const ratingInput = document.getElementById('rating-value');
	const form = document.getElementById('review-form');
	const submitBtn = document.getElementById('submit-btn');
	const contentInput = document.getElementById('comment');
	const errorAlert = document.getElementById('form-error-alert');
	const errorList = document.getElementById('error-list');
	
	function syncStars(value) {
		stars.forEach(function (star) {
			const starValue = parseInt(star.dataset.value, 10);
			if (starValue <= value) {
				star.classList.add('text-primary');
				star.classList.remove('text-neutral-300');
			} else {
				star.classList.add('text-neutral-300');
				star.classList.remove('text-primary');
			}
		});
	}
	
	function validateForm() {
		const errors = [];
		
		// Check rating
		const rating = parseInt(ratingInput.value, 10);
		if (!rating || rating < 1 || rating > 5) {
			errors.push('Please select a rating (1-5 stars)');
		}
		
		// Check content
		const content = contentInput.value.trim();
		if (!content) {
			errors.push('Please write your review');
		} else if (content.length < 10) {
			errors.push('Your review must be at least 10 characters long');
		} else if (content.length > 5000) {
			errors.push('Your review cannot exceed 5000 characters');
		}
		
		return errors;
	}
	
	function displayErrors(errors) {
		if (errors.length > 0) {
			errorList.innerHTML = '';
			errors.forEach(function(error) {
				const li = document.createElement('li');
				li.textContent = '- ' + error;
				errorList.appendChild(li);
			});
			errorAlert.classList.remove('hidden');
			return false;
		} else {
			errorAlert.classList.add('hidden');
			return true;
		}
	}
	
	// Add form submission validation
	form.addEventListener('submit', function(e) {
		const errors = validateForm();
		if (!displayErrors(errors)) {
			e.preventDefault();
			// Scroll to error
			errorAlert.scrollIntoView({ behavior: 'smooth', block: 'center' });
		}
	});
	
	// Real-time validation feedback
	contentInput.addEventListener('input', function() {
		const content = contentInput.value.trim();
		let feedback = '';
		
		if (content.length === 0) {
			feedback = '0/5000 characters';
		} else if (content.length < 10) {
			feedback = content.length + '/5000 (minimum 10 characters)';
		} else {
			feedback = content.length + '/5000 characters';
		}
		
		// Update character counter (can be displayed near the textarea)
		console.log('Content length:', feedback);
	});
	
	stars.forEach(function (star) {
		star.addEventListener('click', function () {
			const value = parseInt(star.dataset.value, 10);
			ratingInput.value = value;
			syncStars(value);
			// Clear rating error when a rating is selected
			errorAlert.classList.add('hidden');
		});
		star.addEventListener('keydown', function (event) {
			if (event.key === 'Enter' || event.key === ' ') {
				event.preventDefault();
				star.click();
			}
		});
		star.setAttribute('tabindex', '0');
	});
	
	// Initialize stars with current rating
	syncStars(parseInt(ratingInput.value, 10));

	// Checkbox functionality
	const checkbox = document.getElementById('is_anonymous_input');
	const checkmark = document.getElementById('checkbox-checkmark');
	
	checkbox.addEventListener('change', function() {
		if (checkbox.checked) {
			checkmark.classList.remove('opacity-0');
			checkmark.classList.add('opacity-100');
		} else {
			checkmark.classList.remove('opacity-100');
			checkmark.classList.add('opacity-0');
		}
	});
});

{% if is_edit %}
// Modal functions
function openDeleteModal() {
	const modal = document.getElementById('delete-modal');
	modal.classList.remove('hidden');
	modal.classList.add('flex');
	document.body.classList.add('overflow-hidden');
}

function closeDeleteModal() {
	const modal = document.getElementById('delete-modal');
	modal.classList.add('hidden');
	modal.classList.remove('flex');
	document.body.classList.remove('overflow-hidden');
}

function confirmDelete() {
	document.getElementById('delete-form').submit();
}

// Close modal on escape key
document.addEventListener('keydown', function(event) {
	if (event.key === 'Escape') {
		closeDeleteModal();
	}
});

// Close modal on backdrop click
document.getElementById('delete-modal').addEventListener('click', function(event) {
	if (event.target === this) {
		closeDeleteModal();
	}
});
{% endif %}
</script>